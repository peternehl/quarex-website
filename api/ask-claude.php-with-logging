        // Handle message_delta for usage stats
        if ($type === 'message_delta') {
          $usage = $event['usage'] ?? [];
          // Capture usage data for logging
          $usageData = [
            'model' => $MODEL,
            'expertise' => $expertise,
            'podcast_mode' => $podcastMode,
            'category' => $category,
            'input_tokens' => $usage['input_tokens'] ?? 0,
            'output_tokens' => $usage['output_tokens'] ?? 0,
            'cache_creation_tokens' => $usage['cache_creation_input_tokens'] ?? 0,
            'cache_read_tokens' => $usage['cache_read_input_tokens'] ?? 0,
            'web_search_requests' => $usage['server_tool_use']['web_search_requests'] ?? 0
          ];
          // Check for web search in usage stats
          if (isset($usage['server_tool_use']['web_search_requests']) && $usage['server_tool_use']['web_search_requests'] > 0) {
            $searchUsed = true;
          }
        }

        // Handle message_stop - send final metadata
        if ($type === 'message_stop') {
          // Log usage to database
          if (!empty($usageData)) {
            log_api_usage($usageData);
          }

          // Extract follow-up questions
          $followups = extract_followup_questions($fullText);

          // Format sources
          $sourceList = array_values($sources);
          $sourceList = array_slice($sourceList, 0, 8); // Cap at 8

          $markdownLinks = [];
          foreach ($sourceList as $src) {
            if (!empty($src['url'])) {
              $title = !empty($src['title']) ? $src['title'] : parse_url($src['url'], PHP_URL_HOST);
              $markdownLinks[] = "[{$title}]({$src['url']})";
            }
          }

          // Send final metadata event
          echo "data: " . json_encode([
            'type' => 'done',
            'mode' => $searchUsed ? 'web-grounded' : 'model-fallback',
            'markdown_links' => $markdownLinks,
            'sources' => array_column($sourceList, 'url'),
            'followup_questions' => $followups,
            'llm' => 'claude'
          ]) . "\n\n";
          flush();
        }