<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quarex Research — Deep Source Research</title>
<meta name="description" content="Research any topic using Quarex's library of 39,000+ explorable topics. Download sourced research briefs." />
<link rel="canonical" href="https://quarex.org/compose/" />

<!-- GA4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TMVLTZ6BB5"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-TMVLTZ6BB5');</script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0a0f1a;
  --panel: #0f1726;
  --ink: #e6eefc;
  --muted: #b6c3df;
  --brand: #7aa7ff;
  --brand-dim: rgba(122,167,255,.15);
  --ring: rgba(122,167,255,.5);
  --border: rgba(255,255,255,.08);
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --radius: 14px;
  --success: #4ade80;
  --warn: #fbbf24;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  color: var(--ink);
  background: radial-gradient(900px 500px at 90% -10%, rgba(122,167,255,.08), transparent), var(--bg);
  min-height: 100vh;
  line-height: 1.5;
}

.wrap { max-width: 960px; margin: 0 auto; padding: 20px; }

/* Navigation */
.nav { display: flex; align-items: center; justify-content: space-between; padding: 16px 0 24px; }
.brand { font-size: 1.3rem; font-weight: 800; color: var(--brand); letter-spacing: -0.02em; }
.brand span { color: var(--ink); font-weight: 300; margin-left: 6px; }
.back { color: var(--muted); text-decoration: none; font-size: 0.85rem; }
.back:hover { color: var(--ink); }

/* Panels */
.panel {
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
}

/* Step indicator */
.steps {
  display: flex; gap: 4px; margin-bottom: 24px;
}
.step-dot {
  flex: 1; height: 4px; border-radius: 2px;
  background: rgba(255,255,255,.08);
  transition: background 0.3s;
}
.step-dot.active { background: var(--brand); }
.step-dot.done { background: var(--success); }

/* Section titles */
h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--ink); }
h2 .count { color: var(--muted); font-weight: 400; font-size: 0.9rem; margin-left: 8px; }

/* Input area */
.topic-input {
  width: 100%; padding: 14px 16px;
  background: rgba(0,0,0,.3); border: 1px solid rgba(122,167,255,.2);
  border-radius: 12px; color: var(--ink); font-family: inherit;
  font-size: 1rem; resize: none; min-height: 56px; max-height: 120px;
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;
}
.topic-input:focus {
  border-color: var(--brand);
  box-shadow: 0 0 0 3px var(--ring);
}
.topic-input::placeholder { color: var(--muted); }

/* Controls row */
.controls {
  display: flex; gap: 10px;
  margin-top: 14px;
}
.control-group label {
  display: block; font-size: 0.75rem; color: var(--muted);
  margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em;
}
.control-group select {
  width: 100%; padding: 8px 10px;
  background: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.1);
  border-radius: 8px; color: var(--ink); font-family: inherit;
  font-size: 0.85rem; outline: none; cursor: pointer;
}
.control-group select:focus { border-color: var(--brand); }

/* Buttons */
.btn {
  padding: 10px 20px; border: none; border-radius: 10px;
  font-family: inherit; font-size: 0.9rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.btn-primary {
  background: var(--brand); color: #0a0f1a;
}
.btn-primary:hover { background: #5db3ff; }
.btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-secondary {
  background: rgba(255,255,255,.08); color: var(--ink);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: rgba(255,255,255,.12); }
.btn-secondary:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-row { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }

/* Search results */
.results-group { margin-bottom: 20px; }
.results-group-header {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
}
.results-group-header h3 {
  font-size: 0.9rem; font-weight: 600; color: var(--brand);
}
.results-group-header .book-meta {
  font-size: 0.75rem; color: var(--muted);
}
.topic-row {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 12px; border-radius: 8px;
  transition: background 0.15s; cursor: pointer;
}
.topic-row:hover { background: rgba(122,167,255,.06); }
.topic-row input[type="checkbox"] {
  margin-top: 3px; accent-color: var(--brand);
  width: 16px; height: 16px; flex-shrink: 0;
}
.topic-row .question { font-size: 0.9rem; color: var(--ink); }
.topic-row .chapter-tag {
  font-size: 0.7rem; color: var(--muted); background: rgba(255,255,255,.05);
  padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block;
}
.select-all-row {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 12px; font-size: 0.8rem; color: var(--muted);
  cursor: pointer;
}

/* Research progress */
.research-item {
  padding: 14px; margin-bottom: 10px;
  background: rgba(0,0,0,.2); border: 1px solid var(--border);
  border-radius: 10px;
}
.research-item .question-header {
  font-size: 0.85rem; font-weight: 600; color: var(--brand);
  margin-bottom: 6px;
}
.research-item .answer {
  font-size: 0.9rem; color: var(--ink); line-height: 1.6;
}
.research-item .source-link {
  display: inline-block; margin-top: 8px;
  font-size: 0.8rem; color: var(--brand); text-decoration: none;
}
.research-item .source-link:hover { text-decoration: underline; }
.research-item.loading {
  border-color: var(--brand-dim);
}
.research-item.loading .answer {
  color: var(--muted); font-style: italic;
}

/* Progress bar */
.progress-bar {
  width: 100%; height: 4px; background: rgba(255,255,255,.08);
  border-radius: 2px; margin-bottom: 16px; overflow: hidden;
}
.progress-fill {
  height: 100%; background: var(--brand);
  border-radius: 2px; transition: width 0.3s;
  width: 0%;
}

/* Status messages */
.status {
  padding: 10px 14px; border-radius: 8px;
  font-size: 0.85rem; margin-bottom: 12px;
}
.status-info { background: var(--brand-dim); color: var(--brand); }
.status-warn { background: rgba(251,191,36,.1); color: var(--warn); }

/* Hidden sections */
.hidden { display: none; }

/* Responsive */
@media (max-width: 700px) {
  .wrap { padding: 12px; }
  .panel { padding: 16px; }
}
</style>
</head>
<body>
<div class="wrap">

  <!-- Nav -->
  <nav class="nav">
    <div class="brand">Quarex<span>Research</span></div>
    <a class="back" href="/">&#8592; Back to Quarex</a>
  </nav>

  <!-- Step indicators -->
  <div class="steps">
    <div class="step-dot active" data-step="1"></div>
    <div class="step-dot" data-step="2"></div>
    <div class="step-dot" data-step="3"></div>
  </div>

  <!-- Topic banner (visible during steps 2-3) -->
  <div id="topicBanner" class="hidden" style="padding:10px 16px;margin-bottom:16px;background:var(--brand-dim);border-radius:10px;font-size:0.9rem;color:var(--brand);font-weight:600;"></div>

  <!-- ============ STEP 1: Input ============ -->
  <div id="step-input" class="panel">
    <h2>What do you want to research?</h2>
    <textarea class="topic-input" id="topicInput" placeholder="e.g., How Taiwan's semiconductor dominance puts the global economy at risk" rows="2"></textarea>

    <div class="controls">
      <div class="control-group">
        <label>Level</label>
        <select id="ctrlLevel">
          <option value="introductory">Introductory</option>
          <option value="intermediate" selected>Intermediate</option>
          <option value="advanced">Advanced</option>
        </select>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="btnSearch" disabled>Search Quarex Topics</button>
    </div>
    <p style="margin-top:12px;font-size:0.8rem;color:var(--muted);">
      New to Quarex Research? <a href="quarex-research-ai-guide.md" download style="color:var(--brand);">Download the AI Composition Guide</a> to learn how to turn your research into finished articles.
    </p>
  </div>

  <!-- ============ STEP 2: Select Topics ============ -->
  <div id="step-select" class="panel hidden">
    <h2>Select Your Sources <span class="count" id="topicCount"></span></h2>
    <div class="btn-row" style="margin-top:0;margin-bottom:16px;">
      <button class="btn btn-secondary" id="btnBackToInput">Back</button>
      <button class="btn btn-primary" id="btnResearch" disabled>Research Selected Topics</button>
    </div>
    <div id="searchStatus" class="status status-info hidden"></div>
    <div id="searchResults"></div>
  </div>

  <!-- ============ STEP 3: Research ============ -->
  <div id="step-research" class="panel hidden">
    <h2>Researching Topics</h2>
    <div class="btn-row" style="margin-top:0;margin-bottom:16px;">
      <button class="btn btn-secondary" id="btnBackToSelect">Back</button>
      <button class="btn btn-secondary" id="btnDownloadResearch" disabled>Download Research</button>
      <button class="btn btn-secondary" id="btnDownloadSources" disabled>Download Sources</button>
      <button class="btn btn-secondary" id="btnDownloadInstructions" disabled>Download AI Instructions</button>
      <button class="btn btn-primary" id="btnStartOver" disabled>Start Over</button>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="researchProgress"></div></div>
    <div id="researchStatus" class="status status-info"></div>
    <div id="researchResults"></div>
  </div>

</div>

<script>
// ======================== State ========================
const state = {
  topic: '',
  level: 'intermediate',
  searchResults: [],
  selectedTopics: [],
  researchBrief: [],
};

// ======================== Elements ========================
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

const elTopicInput = $('#topicInput');
const elBtnSearch = $('#btnSearch');
const elBtnResearch = $('#btnResearch');
const elSearchResults = $('#searchResults');
const elResearchResults = $('#researchResults');

// ======================== Step Navigation ========================
function showStep(stepNum) {
  ['step-input', 'step-select', 'step-research'].forEach((id, i) => {
    const el = document.getElementById(id);
    el.classList.toggle('hidden', i !== stepNum - 1);
  });
  $$('.step-dot').forEach((dot, i) => {
    dot.classList.toggle('active', i === stepNum - 1);
    dot.classList.toggle('done', i < stepNum - 1);
  });

  // Show topic banner on steps 2-3
  const banner = $('#topicBanner');
  if (stepNum > 1 && state.topic) {
    banner.textContent = state.topic;
    banner.classList.remove('hidden');
  } else {
    banner.classList.add('hidden');
  }

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ======================== Step 1: Input ========================
elTopicInput.addEventListener('input', () => {
  elBtnSearch.disabled = elTopicInput.value.trim().length < 3;
});

elBtnSearch.addEventListener('click', async () => {
  state.topic = elTopicInput.value.trim();
  state.level = $('#ctrlLevel').value;

  elBtnSearch.disabled = true;
  elBtnSearch.textContent = 'Searching...';

  try {
    await searchTopics(state.topic);
    showStep(2);
  } catch (err) {
    alert('Search failed: ' + err.message);
  } finally {
    elBtnSearch.disabled = false;
    elBtnSearch.textContent = 'Search Quarex Topics';
  }
});

// ======================== Step 2: Search & Select ========================
async function searchTopics(query) {
  const resp = await fetch('/api/compose-search.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ q: query, limit: 40 }),
  });

  if (!resp.ok) throw new Error('Search returned ' + resp.status);
  const data = await resp.json();

  if (data.error) throw new Error(data.error);

  state.searchResults = data.results || [];
  renderSearchResults();
}

function renderSearchResults() {
  const results = state.searchResults;
  const container = elSearchResults;
  container.innerHTML = '';

  if (results.length === 0) {
    container.innerHTML = '<p style="color:var(--muted);padding:20px;">No matching topics found. Try different keywords.</p>';
    $('#topicCount').textContent = '';
    return;
  }

  // Pre-select top 6, max 12 allowed
  const maxSelect = 12;

  // Group by book
  const byBook = {};
  results.forEach(r => {
    const key = r.book;
    if (!byBook[key]) byBook[key] = { meta: r, topics: [] };
    byBook[key].topics.push(r);
  });

  let selectCount = 0;

  Object.entries(byBook).forEach(([bookName, group]) => {
    const div = document.createElement('div');
    div.className = 'results-group';

    const header = document.createElement('div');
    header.className = 'results-group-header';
    header.innerHTML = `<h3>${esc(bookName)}</h3>
      <span class="book-meta">${esc(group.meta.library)} &middot; ${esc(group.meta.shelf)}</span>`;
    div.appendChild(header);

    group.topics.forEach(topic => {
      const preSelected = selectCount < maxSelect;
      if (preSelected) selectCount++;

      const row = document.createElement('label');
      row.className = 'topic-row';
      row.innerHTML = `
        <input type="checkbox" data-topic-id="${topic.topic_id}" ${preSelected ? 'checked' : ''}>
        <div>
          <div class="question">${esc(topic.question)}</div>
          <span class="chapter-tag">${esc(topic.chapter)}</span>
        </div>`;
      div.appendChild(row);
    });

    container.appendChild(div);
  });

  updateSelectedCount();
  $('#topicCount').textContent = `(${results.length} topics found)`;

  // Listen for checkbox changes
  container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
  });
}

function updateSelectedCount() {
  const allCbs = elSearchResults.querySelectorAll('input[type="checkbox"]');
  const checked = elSearchResults.querySelectorAll('input[type="checkbox"]:checked');
  const count = checked.length;

  // Enforce max 6: disable unchecked boxes when at limit
  allCbs.forEach(cb => {
    if (!cb.checked) cb.disabled = count >= 12;
  });

  elBtnResearch.disabled = count === 0;
  elBtnResearch.textContent = count > 0
    ? `Research ${count} Topic${count > 1 ? 's' : ''} (max 12)`
    : 'Research Selected Topics';
}

$('#btnBackToInput').addEventListener('click', () => showStep(1));

// ======================== Step 3: Research ========================
elBtnResearch.addEventListener('click', async () => {
  // Gather selected topics
  const checked = elSearchResults.querySelectorAll('input[type="checkbox"]:checked');
  state.selectedTopics = [];

  checked.forEach(cb => {
    const topicId = parseInt(cb.dataset.topicId);
    const topic = state.searchResults.find(r => r.topic_id === topicId);
    if (topic) state.selectedTopics.push(topic);
  });

  showStep(3);
  await researchTopics();
});

async function researchTopics() {
  const topics = state.selectedTopics;
  const container = elResearchResults;
  const progressFill = $('#researchProgress');
  const statusEl = $('#researchStatus');
  container.innerHTML = '';
  state.researchBrief = [];

  for (let i = 0; i < topics.length; i++) {
    const topic = topics[i];
    const pct = ((i / topics.length) * 100).toFixed(0);
    progressFill.style.width = pct + '%';
    statusEl.textContent = `Researching topic ${i + 1} of ${topics.length}...`;

    // Create placeholder
    const item = document.createElement('div');
    item.className = 'research-item loading';
    item.innerHTML = `
      <div class="question-header">${esc(topic.question)}</div>
      <div class="answer">Researching...</div>`;
    container.appendChild(item);

    // Call ask-claude.php
    try {
      const answer = await askClaude(topic.question, state.level);
      const answerEl = item.querySelector('.answer');
      answerEl.textContent = answer;
      item.classList.remove('loading');

      // Build the Quarex library deep link (book level)
      const libUrl = `https://quarex.org/libraries/?t=${topic.type_abbrev}&lib=${topic.library_slug}&s=${topic.shelf_slug}&b=${topic.book_slug}`;

      // Add source link
      const link = document.createElement('a');
      link.className = 'source-link';
      link.href = libUrl;
      link.target = '_blank';
      link.textContent = topic.book + ' \u2014 ' + topic.chapter;
      item.appendChild(link);

      state.researchBrief.push({
        question: topic.question,
        answer: answer,
        book: topic.book,
        chapter: topic.chapter,
        libUrl: libUrl,
      });
    } catch (err) {
      item.querySelector('.answer').textContent = 'Error: ' + err.message;
      item.classList.remove('loading');
    }

    container.scrollTop = container.scrollHeight;
  }

  progressFill.style.width = '100%';
  statusEl.textContent = `Research complete \u2014 ${state.researchBrief.length} topics gathered.`;
  $('#btnDownloadResearch').disabled = state.researchBrief.length === 0;
  $('#btnDownloadSources').disabled = state.researchBrief.length === 0;
  $('#btnDownloadInstructions').disabled = state.researchBrief.length === 0;
  $('#btnStartOver').disabled = false;
}

async function askClaude(question, expertise) {
  const resp = await fetch('/api/ask-claude.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      q: question,
      expertise: expertise,
      stream: false,
    }),
  });

  if (!resp.ok) throw new Error('API returned ' + resp.status);
  const data = await resp.json();

  if (data.error) throw new Error(data.error);
  return data.text || data.html || '';
}

$('#btnBackToSelect').addEventListener('click', () => showStep(2));

// ======================== Download Actions ========================
$('#btnDownloadResearch').addEventListener('click', () => {
  if (!state.researchBrief.length) return;
  let md = `# Research: ${state.topic}\n\n`;
  state.researchBrief.forEach((item, i) => {
    md += `---\n\n## ${i + 1}. ${item.question}\n`;
    md += `**Source:** ${item.book} > ${item.chapter}\n`;
    md += `**Link:** [${item.book}](${item.libUrl})\n\n`;
    md += `${item.answer}\n\n`;
  });
  const blob = new Blob([md], { type: 'text/markdown' });
  downloadBlob(blob, slugify(state.topic) + '-research.md');
});

$('#btnDownloadSources').addEventListener('click', () => {
  if (!state.researchBrief.length) return;
  let md = `# Sources: ${state.topic}\n\n`;
  state.researchBrief.forEach((item, i) => {
    md += `## ${i + 1}. ${item.book}\n`;
    md += `**Chapter:** ${item.chapter}\n`;
    md += `**Topic:** ${item.question}\n`;
    md += `**Link:** [${item.book}](${item.libUrl})\n\n`;
  });
  const blob = new Blob([md], { type: 'text/markdown' });
  downloadBlob(blob, slugify(state.topic) + '-sources.md');
});

$('#btnDownloadInstructions').addEventListener('click', () => {
  if (!state.researchBrief.length) return;

  const sourceList = state.researchBrief.map((item, i) =>
    `${i + 1}. "${item.question}" — ${item.book} > ${item.chapter}\n   Link: ${item.libUrl}`
  ).join('\n');

  const md = `# AI Composition Instructions
## Topic: ${state.topic}

Use these instructions with your preferred AI (Claude, ChatGPT, Gemini, etc.) to compose a finished article from the Quarex Research download.

---

## How to Use

1. Open your AI assistant of choice
2. Paste this entire file into the chat
3. Then paste the contents of your **Research download** file (${slugify(state.topic)}-research.md)
4. The AI will compose your article using only the researched material

---

## Choose a Format

Pick ONE of the four format instructions below, then delete the other three before pasting.

### Format A: Blog Post
Write a blog post at ${state.level} level about: "${state.topic}"

Voice: Conversational but authoritative. Use short paragraphs, rhetorical questions, and concrete examples. Open with a hook that makes the reader care. Use "you" and "we" naturally. End with a forward-looking conclusion, not a summary.

Structure: Title, opening hook (2-3 sentences), 3-5 sections with subheadings, closing paragraph.

### Format B: Article
Write a magazine-style article at ${state.level} level about: "${state.topic}"

Voice: Polished, narrative-driven. Blend data with storytelling. Each section should advance an argument. Use transitional sentences between sections. Maintain a neutral analytical tone while keeping the reader engaged.

Structure: Title, lede paragraph, 4-6 sections with subheadings, conclusion that synthesizes the argument.

### Format C: Research Paper
Write a research paper at ${state.level} level about: "${state.topic}"

Voice: Academic and precise. Define terms on first use. Use hedging language where evidence is uncertain ("suggests," "indicates"). Present competing interpretations. Maintain strict objectivity.

Structure: Title, Abstract (150 words), Introduction, 3-5 body sections, Discussion, Conclusion, References.

### Format D: Briefing
Write an executive briefing at ${state.level} level about: "${state.topic}"

Voice: Direct and decisive. Lead with the bottom line. Use bullet points for key findings. Highlight risks and opportunities. No filler, no hedging — decision-makers need clarity.

Structure: Title, Key Findings (3-5 bullets), Background (2-3 paragraphs), Analysis (3-4 sections), Implications, Recommended Actions.

---

## Composition Rules

1. **The Quarex research material is your primary source.** Build the article's structure and core arguments from it.
2. **You may supplement with your own knowledge** to fill gaps, add context, provide recent data, or strengthen the analysis — but clearly distinguish supplementary material from sourced material.
3. **Cite Quarex sources inline.** When referencing a Quarex finding, link to the source using markdown: [Book Title](URL). The sources are listed below.
4. **Label outside additions.** When adding information not from the research material, do not fabricate a Quarex citation. Either note the claim without a link, or if you can provide a real external URL, cite it separately.
5. **Do not invent statistics, quotes, or claims** and attribute them to the Quarex research.
6. **Maintain the expertise level** specified above (${state.level}).
7. **Preserve all Quarex source links** so readers can explore further.
8. **Add a footer** at the end: "Researched with [Quarex Research](https://quarex.org/compose/)"

---

## Your Quarex Sources

${sourceList}

---

## Research Material

Paste the contents of your Research download file below this line:

`;

  const blob = new Blob([md], { type: 'text/markdown' });
  downloadBlob(blob, slugify(state.topic) + '-ai-instructions.md');
});

function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '').substring(0, 60);
}

$('#btnStartOver').addEventListener('click', () => {
  state.searchResults = [];
  state.selectedTopics = [];
  state.researchBrief = [];
  elSearchResults.innerHTML = '';
  elResearchResults.innerHTML = '';
  showStep(1);
});

// ======================== Utilities ========================
function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
