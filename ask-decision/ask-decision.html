<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TMVLTZ6BB5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TMVLTZ6BB5');
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quarex Decision Helper — Explore Every Facet</title>
  <meta name="description" content="Use the Quarex methodology to explore every facet of a decision. Structured decision-making with AI-powered analysis." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0A0A0A;
      --ink: #F7F7F7;
      --muted: #B7BCC2;
      --line: #262626;
      --card: #111111;
      --accent: #7CB9FF;
      --brand: #EDEDED;
      --blue: #3B82F6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font: 16px/1.6 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: url('../assets/living-book-iceberg.png') center center / cover fixed no-repeat;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }

    .page-overlay {
      min-height: 100vh;
      background: rgba(0, 0, 0, 0.3);
    }

    a { color: var(--blue); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Header */
    .header {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 {
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: clamp(24px, 4vw, 32px);
      color: var(--brand);
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
    }
    .header .tagline {
      font-size: 1rem;
      color: var(--accent);
      font-style: italic;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
      font-weight: 600;
      transition: all 0.2s;
      text-decoration: none;
    }
    .back-link:hover {
      background: rgba(255, 255, 255, 0.2);
      text-decoration: none;
    }

    /* Main Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 60px;
    }

    /* Explorer Layout - two columns when active */
    .explorer-layout {
      display: none;
      grid-template-columns: 280px 1fr;
      gap: 20px;
    }
    .explorer-layout.active {
      display: grid;
    }

    /* History Sidebar */
    .history-sidebar {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(15, 23, 42, 0.5);
      padding: 16px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      position: sticky;
      top: 20px;
    }
    .history-sidebar h3 {
      font-family: "Playfair Display", serif;
      font-size: 1rem;
      color: var(--accent);
      margin: 0 0 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .history-section {
      margin-bottom: 16px;
    }
    .history-section-title {
      font-size: 0.8rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .history-section-title .step-num {
      background: rgba(124, 185, 255, 0.2);
      color: var(--accent);
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }
    .history-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1.4;
    }
    .history-item:hover {
      background: rgba(124, 185, 255, 0.15);
      border-color: rgba(124, 185, 255, 0.3);
    }
    .history-item.explored {
      border-left: 3px solid var(--accent);
    }
    .history-item.unexplored {
      opacity: 0.7;
      border-left: 3px solid rgba(255, 255, 255, 0.2);
    }
    .history-item.current {
      background: rgba(124, 185, 255, 0.2);
      border-color: var(--accent);
    }
    .history-item-label {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .history-item-status {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 4px;
    }

    @media (max-width: 900px) {
      .explorer-layout {
        grid-template-columns: 1fr;
      }
      .history-sidebar {
        position: static;
        max-height: none;
        order: 2;
      }
    }

    /* Setup Panel */
    .setup-panel {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 8px 28px rgba(15, 23, 42, 0.5);
    }
    .setup-panel h2 {
      font-family: "Playfair Display", serif;
      font-size: clamp(22px, 3vw, 28px);
      color: var(--accent);
      margin-bottom: 24px;
      text-align: center;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group.full {
      grid-column: 1 / -1;
    }
    .form-group label {
      font-size: 0.95rem;
      color: var(--muted);
      font-weight: 600;
    }
    .form-group select,
    .form-group textarea {
      background: rgba(255, 255, 255, 0.95);
      color: #111;
      border: none;
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: box-shadow 0.2s;
    }
    .form-group select:focus,
    .form-group textarea:focus {
      box-shadow: 0 0 0 3px rgba(124, 185, 255, 0.5);
    }
    .form-group textarea {
      min-height: 120px;
      resize: vertical;
    }
    .form-group textarea::placeholder {
      color: #666;
    }

    .start-btn {
      display: block;
      width: 100%;
      margin-top: 20px;
      padding: 16px 32px;
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      border: none;
      border-radius: 12px;
      color: var(--accent);
      font-family: "Playfair Display", serif;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4);
    }
    .start-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(30, 58, 138, 0.5);
      filter: brightness(1.1);
    }
    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      filter: none;
    }

    /* Explorer Panel */
    .explorer-panel {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 8px 28px rgba(15, 23, 42, 0.5);
      display: none;
      flex-direction: column;
      min-height: 500px;
    }
    .explorer-panel.active {
      display: flex;
    }

    /* Breadcrumb */
    .breadcrumb {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }
    .breadcrumb-item {
      color: var(--muted);
      cursor: pointer;
      padding: 6px 10px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .breadcrumb-item:hover {
      background: rgba(124, 185, 255, 0.15);
      color: var(--ink);
    }
    .breadcrumb-item.current {
      color: var(--accent);
      font-weight: 600;
      cursor: default;
    }
    .breadcrumb-item.current:hover {
      background: transparent;
    }
    .breadcrumb-sep {
      color: rgba(255, 255, 255, 0.3);
    }

    /* Context Bar */
    .context-bar {
      padding: 12px 20px;
      background: rgba(124, 185, 255, 0.1);
      border-bottom: 1px solid rgba(124, 185, 255, 0.2);
      font-size: 0.9rem;
      color: var(--muted);
    }
    .context-bar b {
      color: var(--accent);
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bubble {
      max-width: 88%;
      padding: 16px 20px;
      border-radius: 14px;
      line-height: 1.7;
    }
    .bubble.ai {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }
    .bubble.user {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.6), rgba(30, 64, 175, 0.6));
      border: 1px solid rgba(124, 185, 255, 0.4);
    }
    .bubble.thinking {
      opacity: 0.7;
      font-style: italic;
    }

    /* Facet Buttons */
    .facet-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }
    .facet-btn {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.4), rgba(30, 64, 175, 0.4));
      border: 1px solid rgba(124, 185, 255, 0.35);
      color: var(--ink);
      padding: 14px 18px;
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      font-size: 1rem;
      line-height: 1.5;
      transition: all 0.2s;
    }
    .facet-btn:hover {
      background: linear-gradient(135deg, rgba(30, 58, 138, 0.6), rgba(30, 64, 175, 0.6));
      border-color: rgba(124, 185, 255, 0.6);
      transform: translateX(6px);
    }

    /* Custom Question Input */
    .custom-question {
      display: flex;
      gap: 10px;
      padding: 12px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(0, 0, 0, 0.15);
    }
    .custom-question input {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      color: #111;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-family: inherit;
      outline: none;
    }
    .custom-question input:focus {
      box-shadow: 0 0 0 3px rgba(124, 185, 255, 0.5);
    }
    .custom-question input::placeholder {
      color: #666;
    }
    .ask-custom-btn {
      background: linear-gradient(135deg, #1e3a8a, #1e40af);
      border: none;
      border-radius: 10px;
      color: var(--accent);
      padding: 12px 24px;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ask-custom-btn:hover {
      filter: brightness(1.15);
    }
    .ask-custom-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Nav Controls */
    .nav-controls {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
    }
    .nav-btn {
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s;
      border: none;
    }
    .nav-btn.back-btn {
      background: rgba(255, 255, 255, 0.1);
      color: var(--ink);
    }
    .nav-btn.back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .nav-btn.back-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .nav-btn.restart-btn {
      background: transparent;
      border: 1px solid rgba(124, 185, 255, 0.4);
      color: var(--accent);
      margin-left: auto;
    }
    .nav-btn.restart-btn:hover {
      background: rgba(124, 185, 255, 0.1);
    }

    /* Summary Panel */
    .summary-panel {
      background: rgba(124, 185, 255, 0.1);
      border: 1px solid rgba(124, 185, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    .summary-panel h4 {
      margin: 0 0 16px;
      color: var(--accent);
      font-family: "Playfair Display", serif;
      font-size: 1.1rem;
    }
    .summary-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .summary-list li {
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.95rem;
    }
    .summary-list li:last-child {
      border-bottom: none;
    }
    .summary-list .facet-name {
      color: var(--muted);
    }
    .summary-list .facet-choice {
      color: var(--ink);
      font-weight: 500;
    }

    /* Footer */
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 24px 20px 40px;
      font-size: 0.9rem;
      color: var(--muted);
      border-top: 1px solid var(--line);
    }
    footer a {
      color: var(--accent);
      margin: 0 8px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }
      .setup-panel, .explorer-panel {
        border-radius: 12px;
        padding: 24px 16px;
      }
    }

    @media (max-width: 480px) {
      .bubble {
        max-width: 95%;
      }
      .facet-btn {
        padding: 12px 14px;
        font-size: 0.95rem;
      }
    }
  </style>
</head>
<body>

<div class="page-overlay">
  <!-- Header -->
  <header class="header">
    <div>
      <h1>Quarex Decision Helper</h1>
      <p class="tagline">Explore Every Facet</p>
    </div>
    <a href="/" class="back-link">← Back to Quarex</a>
  </header>

  <div class="container">
    <!-- Setup Panel -->
    <div id="setupPanel" class="setup-panel">
      <h2>What decision are you facing?</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="decisionType">Decision Type</label>
          <select id="decisionType">
            <option value="">Select a category...</option>
            <option value="career">Career / Job</option>
            <option value="financial">Financial / Investment</option>
            <option value="relationship">Relationship / Family</option>
            <option value="health">Health / Medical</option>
            <option value="education">Education / Learning</option>
            <option value="housing">Housing / Relocation</option>
            <option value="business">Business / Entrepreneurship</option>
            <option value="legal">Legal / Contracts</option>
            <option value="technology">Technology / Purchases</option>
            <option value="lifestyle">Lifestyle / Habits</option>
            <option value="ethical">Ethical / Moral Dilemma</option>
            <option value="creative">Creative / Project Direction</option>
            <option value="political">Political / Policy</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label for="timeframe">Decision Timeframe</label>
          <select id="timeframe">
            <option value="">When do you need to decide?</option>
            <option value="immediate">Immediate (today)</option>
            <option value="week">This week</option>
            <option value="month">This month</option>
            <option value="quarter">This quarter</option>
            <option value="year">This year</option>
            <option value="longterm">Long-term (1+ years)</option>
            <option value="none">No deadline</option>
          </select>
        </div>
      </div>

      <div class="form-group full">
        <label for="decisionText">Describe your decision</label>
        <textarea id="decisionText" placeholder="Example: I'm considering whether to accept a job offer in another city. The salary is 20% higher but I'd have to relocate away from family..."></textarea>
      </div>

      <button id="startBtn" class="start-btn" disabled>Begin Decision Analysis</button>
    </div>

    <!-- Explorer Layout (Sidebar + Main Panel) -->
    <div id="explorerLayout" class="explorer-layout">
      <!-- History Sidebar -->
      <aside id="historySidebar" class="history-sidebar">
        <h3>Exploration History</h3>
        <div id="historyContent">
          <!-- Populated dynamically -->
        </div>
      </aside>

      <!-- Explorer Panel -->
      <div id="explorerPanel" class="explorer-panel active">
        <div id="breadcrumb" class="breadcrumb">
          <span class="breadcrumb-item current">Start</span>
        </div>

        <div id="contextBar" class="context-bar">
          <b>Decision:</b> <span id="contextDecision"></span>
        </div>

        <div id="messages" class="messages">
          <!-- AI responses and facet options appear here -->
        </div>

        <!-- Custom Question Input -->
        <div class="custom-question">
          <input type="text" id="customQuestion" placeholder="Type your own follow-up question..." />
          <button id="askCustomBtn" class="ask-custom-btn">Ask</button>
        </div>

        <div class="nav-controls">
          <button id="backBtn" class="nav-btn back-btn" disabled>← Back</button>
          <button id="restartBtn" class="nav-btn restart-btn">Start Over</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 Quarex / Peter Nehl. All Rights Reserved.<br>
    <a href="/privacy.html">Privacy Policy</a> &bull; <a href="/ethics/">Ethics</a>
  </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SITE_PREFIX = window.location.pathname.includes('/Quarex/') ? '/Quarex' : '';

  // Elements
  const setupPanel = document.getElementById('setupPanel');
  const explorerLayout = document.getElementById('explorerLayout');
  const explorerPanel = document.getElementById('explorerPanel');
  const historyContent = document.getElementById('historyContent');
  const decisionType = document.getElementById('decisionType');
  const timeframe = document.getElementById('timeframe');
  const decisionText = document.getElementById('decisionText');
  const startBtn = document.getElementById('startBtn');
  const backBtn = document.getElementById('backBtn');
  const restartBtn = document.getElementById('restartBtn');
  const messages = document.getElementById('messages');
  const breadcrumb = document.getElementById('breadcrumb');
  const contextDecision = document.getElementById('contextDecision');
  const customQuestion = document.getElementById('customQuestion');
  const askCustomBtn = document.getElementById('askCustomBtn');

  // State
  let history = []; // Array of {facet, choice, response, facets, allFacets}
  let currentDecision = {};
  let explorationTree = []; // Tracks all facets at each step, explored or not

  // Enable start button when form is filled
  function checkForm() {
    const valid = decisionType.value && timeframe.value && decisionText.value.trim().length > 10;
    startBtn.disabled = !valid;
  }
  decisionType.addEventListener('change', checkForm);
  timeframe.addEventListener('change', checkForm);
  decisionText.addEventListener('input', checkForm);

  // Start analysis
  startBtn.addEventListener('click', async () => {
    currentDecision = {
      type: decisionType.value,
      typeName: decisionType.options[decisionType.selectedIndex].text,
      timeframe: timeframe.value,
      timeframeName: timeframe.options[timeframe.selectedIndex].text,
      text: decisionText.value.trim()
    };

    // Switch panels
    setupPanel.style.display = 'none';
    explorerLayout.classList.add('active');
    contextDecision.textContent = currentDecision.text.substring(0, 100) + (currentDecision.text.length > 100 ? '...' : '');

    // Reset state
    history = [];
    explorationTree = [];
    updateBreadcrumb();
    updateBackButton();
    updateHistorySidebar();

    // Get initial analysis
    await analyzeDecision('initial');
  });

  // Back button
  backBtn.addEventListener('click', () => {
    if (history.length > 1) {
      history.pop(); // Remove current
      const prev = history[history.length - 1];
      renderState(prev);
      updateBreadcrumb();
      updateBackButton();
    } else if (history.length === 1) {
      // Go back to initial state - re-fetch
      history = [];
      updateBreadcrumb();
      updateBackButton();
      analyzeDecision('initial');
    }
  });

  // Restart
  restartBtn.addEventListener('click', () => {
    setupPanel.style.display = 'block';
    explorerLayout.classList.remove('active');
    history = [];
    explorationTree = [];
    messages.innerHTML = '';
    historyContent.innerHTML = '';
    customQuestion.value = '';
  });

  // Custom question submission
  askCustomBtn.addEventListener('click', submitCustomQuestion);
  customQuestion.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      submitCustomQuestion();
    }
  });

  async function submitCustomQuestion() {
    const question = customQuestion.value.trim();
    if (!question) return;

    customQuestion.value = '';
    await analyzeDecision('custom', question);
  }

  // Analyze decision via API
  async function analyzeDecision(facet, choice = null) {
    // Show thinking
    const thinkingEl = document.createElement('div');
    thinkingEl.className = 'bubble ai thinking';
    thinkingEl.textContent = 'Analyzing...';
    messages.appendChild(thinkingEl);
    messages.scrollTop = messages.scrollHeight;

    try {
      const resp = await fetch(SITE_PREFIX + '/api/ask-decision.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          decision: currentDecision,
          facet: facet,
          choice: choice,
          history: history.map(h => ({ facet: h.facet, choice: h.choice }))
        })
      });

      const data = await resp.json();
      thinkingEl.remove();

      if (data.error) {
        showError(data.error);
        return;
      }

      // Add to history
      const state = {
        facet: facet,
        choice: choice,
        response: data.analysis,
        facets: data.facets || [],
        summary: data.summary || null
      };
      history.push(state);

      // Track in exploration tree (all facets at this step)
      explorationTree.push({
        stepNum: history.length,
        explored: choice || 'Initial Overview',
        allFacets: data.facets || [],
        exploredFacets: [choice || 'Initial Overview']
      });

      renderState(state);
      updateBreadcrumb();
      updateBackButton();
      updateHistorySidebar();

    } catch (err) {
      thinkingEl.remove();
      showError('Network error. Please try again.');
      console.error(err);
    }
  }

  // Render a state
  function renderState(state) {
    messages.innerHTML = '';

    // Show the analysis
    const bubble = document.createElement('div');
    bubble.className = 'bubble ai';
    bubble.innerHTML = state.response;
    messages.appendChild(bubble);

    // Show facet buttons if available
    if (state.facets && state.facets.length > 0) {
      const container = document.createElement('div');
      container.className = 'facet-buttons';

      state.facets.forEach(f => {
        const btn = document.createElement('button');
        btn.className = 'facet-btn';
        btn.textContent = f.label;
        btn.onclick = () => analyzeDecision(f.id, f.label);
        container.appendChild(btn);
      });

      messages.appendChild(container);
    }

    // Show summary if available
    if (state.summary) {
      const summaryEl = document.createElement('div');
      summaryEl.className = 'summary-panel';
      summaryEl.innerHTML = `
        <h4>Decision Summary</h4>
        <ul class="summary-list">
          ${state.summary.map(s => `
            <li>
              <span class="facet-name">${escapeHtml(s.facet)}:</span>
              <span class="facet-choice">${escapeHtml(s.insight)}</span>
            </li>
          `).join('')}
        </ul>
      `;
      messages.appendChild(summaryEl);
    }

    messages.scrollTop = messages.scrollHeight;
  }

  // Update breadcrumb
  function updateBreadcrumb() {
    breadcrumb.innerHTML = '';

    // Always show "Start"
    const startItem = document.createElement('span');
    startItem.className = 'breadcrumb-item' + (history.length === 0 ? ' current' : '');
    startItem.textContent = 'Start';
    if (history.length > 0) {
      startItem.onclick = () => {
        history = [];
        updateBreadcrumb();
        updateBackButton();
        analyzeDecision('initial');
      };
    }
    breadcrumb.appendChild(startItem);

    // Add history items
    history.forEach((h, i) => {
      const sep = document.createElement('span');
      sep.className = 'breadcrumb-sep';
      sep.textContent = '›';
      breadcrumb.appendChild(sep);

      const item = document.createElement('span');
      const label = h.choice || getFacetLabel(h.facet);
      item.className = 'breadcrumb-item' + (i === history.length - 1 ? ' current' : '');
      item.textContent = label.length > 20 ? label.substring(0, 20) + '...' : label;
      item.title = label;

      if (i < history.length - 1) {
        item.onclick = () => {
          history = history.slice(0, i + 1);
          renderState(history[i]);
          updateBreadcrumb();
          updateBackButton();
        };
      }
      breadcrumb.appendChild(item);
    });
  }

  function updateBackButton() {
    backBtn.disabled = history.length === 0;
  }

  // Update history sidebar with all exploration paths
  function updateHistorySidebar() {
    historyContent.innerHTML = '';

    explorationTree.forEach((step, stepIndex) => {
      const section = document.createElement('div');
      section.className = 'history-section';

      // Section title
      const title = document.createElement('div');
      title.className = 'history-section-title';
      title.innerHTML = `<span class="step-num">${step.stepNum}</span> ${escapeHtml(step.explored.substring(0, 25))}${step.explored.length > 25 ? '...' : ''}`;
      section.appendChild(title);

      // Show all facets from this step
      step.allFacets.forEach(f => {
        const item = document.createElement('div');
        const isExplored = step.exploredFacets.includes(f.label);
        const isCurrent = stepIndex === explorationTree.length - 1;

        item.className = 'history-item' + (isExplored ? ' explored' : ' unexplored') + (isCurrent && isExplored ? ' current' : '');
        item.innerHTML = `
          <span class="history-item-label" title="${escapeHtml(f.label)}">${escapeHtml(f.label.substring(0, 40))}${f.label.length > 40 ? '...' : ''}</span>
          <span class="history-item-status">${isExplored ? 'Explored' : 'Click to explore'}</span>
        `;

        // Click to explore this facet (even if from an earlier step)
        item.onclick = () => exploreFromSidebar(stepIndex, f);
        section.appendChild(item);
      });

      historyContent.appendChild(section);
    });
  }

  // Explore a facet from the sidebar (can be from any step)
  async function exploreFromSidebar(stepIndex, facet) {
    // Mark this facet as explored in that step
    if (!explorationTree[stepIndex].exploredFacets.includes(facet.label)) {
      explorationTree[stepIndex].exploredFacets.push(facet.label);
    }

    // Trim history to that step and continue from there
    history = history.slice(0, stepIndex + 1);
    explorationTree = explorationTree.slice(0, stepIndex + 1);

    updateBreadcrumb();
    updateHistorySidebar();

    // Analyze the selected facet
    await analyzeDecision(facet.id, facet.label);
  }

  function getFacetLabel(facet) {
    const labels = {
      'initial': 'Overview',
      'pros': 'Pros',
      'cons': 'Cons',
      'risks': 'Risks',
      'alternatives': 'Alternatives',
      'values': 'Values',
      'stakeholders': 'Stakeholders',
      'timeline': 'Timeline',
      'resources': 'Resources',
      'emotions': 'Emotions',
      'worstcase': 'Worst Case',
      'bestcase': 'Best Case'
    };
    return labels[facet] || facet;
  }

  function showError(msg) {
    const err = document.createElement('div');
    err.className = 'bubble ai';
    err.style.borderColor = 'rgba(239,68,68,.5)';
    err.style.background = 'rgba(239,68,68,.1)';
    err.textContent = msg;
    messages.appendChild(err);
    messages.scrollTop = messages.scrollHeight;
  }

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
});
</script>

</body>
</html>
